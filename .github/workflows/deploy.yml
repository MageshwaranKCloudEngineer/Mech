name: MechWiz CI/CD Pipeline (Local K8s + Terraform + Observability + Testing)

on:
  push:
    branches: [dev, test, stage, main]
  workflow_dispatch:

env:
  IMAGE_NAME: mechwiz
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  VERSION_TAG: ${{ github.run_number }}

jobs:
  # 1Ô∏è‚É£ Build & Test with Pytest, Coverage & SonarQube
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.9

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Run unit tests with coverage
        run: |
          echo "‚úÖ Running pytest with coverage..."
          pytest --cov=app.py --cov-report=xml --junitxml=pytest-report.xml test_app.py

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results
          path: pytest-report.xml

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # 2Ô∏è‚É£ Docker Build
  build-docker-local:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

  # 3Ô∏è‚É£ Deploy to environment using kind
  deploy-to-env:
    needs: build-docker-local
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name }}
      url: https://mechwiz-${{ github.ref_name }}.local
    if: |
      github.ref == 'refs/heads/dev' ||
      github.ref == 'refs/heads/test' ||
      github.ref == 'refs/heads/stage' ||
      github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Create kind cluster
        run: kind create cluster --name mechwiz-cluster

      - name: Verify kind cluster
        run: kubectl cluster-info
        
      - name: Create namespace if not exists
        run: |
          ENV=${{ github.ref_name }}
          kubectl create namespace $ENV --dry-run=client -o yaml | kubectl apply -f -

      - name: Build Docker image locally
        run: |
          echo "üîπ Building local Docker image..."
          docker build -t $IMAGE_NAME:latest .

      - name: Load Docker image into kind
        run: kind load docker-image $IMAGE_NAME:latest --name mechwiz-cluster
        

      - name: Apply Kubernetes manifests
        run: |
          ENV=${{ github.ref_name }}
          echo " Deploying to $ENV using flat k8/ manifests"
          sed "s|IMAGE_TAG|${{ github.run_number }}|g" k8/mechwiz-deployment.yaml | \
          sed "s|IMAGE_REPO|$IMAGE_NAME|g" > k8/tmp-mechwiz-deployment.yaml

          kubectl apply -n $ENV -f k8/configmap.yaml
          kubectl apply -n $ENV -f k8/dynamodb-deployment.yaml
          kubectl apply -n $ENV -f k8/dynamodb-service.yaml
          kubectl apply -n $ENV -f k8/grafana-deployment.yaml
          kubectl apply -n $ENV -f k8/prometheus-config.yaml
          kubectl apply -n $ENV -f k8/service.yaml
          kubectl apply -n $ENV -f k8/ingress.yaml
          kubectl apply -n $ENV -f k8/tmp-mechwiz-deployment.yaml


      - name: kubernetes checkup
        run: |
          kubectl get deployment $ENV
          kubectl get svc $ENV
          kubectl get pods $ENV
          

      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0


      - name: Pull DynamoDB Local Docker image
        run: docker pull amazon/dynamodb-local

      - name: Start DynamoDB Local
        run: docker run -d -p 8000:8000 amazon/dynamodb-local

      - name: Terraform Init, Plan & Apply
        run: |
          ENV=${{ github.ref_name }}
          terraform -chdir=terraform/envs/$ENV init
          terraform -chdir=terraform/envs/$ENV plan -out=plan.tfplan
          terraform -chdir=terraform/envs/$ENV apply -auto-approve
        env:
          AWS_ACCESS_KEY_ID: dummy
          AWS_SECRET_ACCESS_KEY: dummy
          TF_VAR_image_repo: $IMAGE_NAME
          TF_VAR_image_tag: ${{ github.run_number }}

      - name: Prometheus Health Check
        run: |
          ENV=${{ github.ref_name }}
          for i in {1..12}; do
            NOT_READY=$(kubectl get pods -n $ENV --no-headers | grep -v 'Running\|Completed' || true)
            if [ -z "$NOT_READY" ]; then
              echo "‚úÖ All pods are running."
              break
            else
              echo "Waiting for pods to be ready..."
              sleep 10
            fi
          done
          if [ ! -z "$NOT_READY" ]; then
            echo "‚ùå Pods not ready after 2 minutes. Failing deployment."
            exit 1
          fi

      - name: Deploy Grafana dashboards (optional)
        run: |
          echo "‚ö†Ô∏è No Grafana dashboards.json found. Skipping dashboard deployment."

  # 4Ô∏è‚É£ Auto-promote Dev ‚Üí Test
  promote-dev-to-test:
    needs: deploy-to-env
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' && needs.deploy-to-env.result == 'success'
    steps:
      - uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: promote-to-test
          client-payload: '{"branch": "test"}'

  # 5Ô∏è‚É£ Wait for manual approval before Prod
  approve-prod:
    needs: deploy-to-env
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: prod
      url: https://mechwiz-prod.local
    steps:
      - name: Await manual approval
        uses: hmarr/auto-approve-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

  # 6Ô∏è‚É£ Listener for promotion events
  handle-promotion:
    if: github.event_name == 'repository_dispatch' && github.event.action == 'promote-to-test'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo "üî• Dev ‚Üí Test promotion triggered"
